<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
      position: fixed;
      overflow: hidden;
      text-align: center;
      background: black;
    }

    img {
      height: 100%;
    }
  </style>
</head>

<body>
  <script>
    let params = (window.location.search || '').replace(/^\?/, '').split('&')
      .map(x => x.split('=').map(decodeURIComponent))
      .reduce((acc, [a, b]) => ((acc[a] = b) && false) || acc, {});

    const PUBLIC_STREAM = 'https://storage.googleapis.com/' + params.appId + '/images/door-snap.jpg';
    const PRIVATE_STREAM = 'http://' + params.ip + '/camera/stream';
    let publicStreaming = true;

    function publicStream() {
      let img = document.createElement('img');
      img.src = PUBLIC_STREAM + '?cache=' + Date.now();
      img.id = 'public';

      const old = document.getElementById('public');
      document.body.insertBefore(img, document.body.childNodes[old ? 1 : 0]);

      if (old) {
        setTimeout(old.remove.bind(old), 1000);
      }

      img.addEventListener('load', () =>
        publicStreaming ? setTimeout(publicStream, 2000) : img.remove()
      );
    }

    let img = document.createElement('img');
    img.id = 'private';
    img.src = PRIVATE_STREAM;
    img.style.display = 'none';
    img.addEventListener('load', () => {
      publicStreaming = false;
      img.style.display = 'inline-block';
    });
    document.body.appendChild(img);

    publicStream();
  </script>
</body>

</html>