<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
      position: fixed;
      overflow: hidden;
      text-align: center;
      background: black;
    }

    img {
      height: 100%;
    }
  </style>
</head>

<body>
  <script>
    let params = (window.location.search || '').replace(/^\?/, '')
      .split('&')
      .map(x => x.split('=').map(decodeURIComponent))
      .reduce((acc, [a, b]) => {
        acc[a] = b;
        return acc;
      }, {});

    let img = document.createElement('img');
    img.src = 'https://storage.googleapis.com/' + params.appId + '/images/door-snap.jpg?cache=' + Date.now();
    document.body.appendChild(img);

    function reload() {
      let src = img.src.replace(/=.+/, Date.now())
      img.src = '';
      setTimeout(() => img.src = src, 0);
    }

    img.remove = img.remove.bind(img);
    img.addEventListener('error', () => setTimeout(reload, 500));

    let img2 = document.createElement('img');
    let imgTimer;

    img2.addEventListener('error', () => {
      img2.removeEventListener('load', () => img.remove());
      img2.remove();
      if (imgTimer) {
        clearInterval(imgTimer);
      }
      imgTimer = setInterval(reload, 2000);
    });
    img2.addEventListener('load', img.remove);

    img2.src = 'http://' + params.ip + '/camera/stream';
    document.body.appendChild(img2);
  </script>
</body>

</html>